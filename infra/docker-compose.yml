  version: '3.8'
  services:
    db:
      image: postgres:15
      environment:
        POSTGRES_DB: foodgram
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: postgres
      ports:
        - "5432:5432"
      volumes:
        - pgdata:/var/lib/postgresql/data/

    backend:
      build:
        context: ../backend
        dockerfile: Dockerfile
      environment:
        DJANGO_SECRET_KEY: "django-insecure-tl6c2r!qdu%45b!yn-xc!$!hxk(u%0044^+s_^o^(q=gl!%wq7"
      command: >
        sh -c "
        until nc -z db 5432; do
          echo 'Waiting for postgres...';
          sleep 1;
        done;
        python manage.py migrate &&
        gunicorn foodgram.wsgi:application --bind 0.0.0.0:8000
        "
      volumes:
        - ../backend/staticfiles:/app/backend/staticfiles/
      depends_on:
        - db

    frontend:
      build:
        context: ../frontend
        dockerfile: Dockerfile
      volumes:
        - ../frontend:/app/result_build/

    nginx:
      image: nginx:1.19.3
      ports:
        - "80:80"
      volumes:
        - ./nginx.conf:/etc/nginx/conf.d/default.conf
        - ../frontend/build:/usr/share/nginx/html/
        - ../backend/foodgram/staticfiles:/usr/share/nginx/html/static/  # <-- правильно!
        - ./docs/:/usr/share/nginx/html/api/docs/
      depends_on:
        - backend


  volumes:
    pgdata:
      driver: local
